## 大型网站技术架构核心原理与案例分析

![封面图片](https://img3.doubanio.com/lpic/s27250675.jpg)

作者:李智慧

出版社:电子工业出版社

----- 

### 大型网站系统的特点

1. 高并发 大流量
2. 高可用
3. 海量数据
4. 用户分布广泛,网络情况复杂
5. 安全环境恶劣
6. 需求快速变更,发布频繁
7. 渐进式发展


### 大型网站架构演化发展历程
---

1. 初始阶段:应用程序,数据库\文件资源在同一台服务器
2. 应用服务器和数据服务分离
3. 使用缓存改善网站性能(本地缓存和远程缓存)
4. 使用应用服务器集群改善网站的并发处理能力
5. 数据库读写分离(二八定律)
6. 使用反向代理和CDN加速网站响应
7. 使用分布式文件系统和分布式数据库系统(将不同业务的数据库部署在不同的物理服务器上)
8. 使用NoSQL和搜索引擎
9. 业务拆分(如电子商务网站的首页,商铺,订单,买家等拆分到不同的产品线)
10. 分布式服务(所有业务通过分布式服务调用公用业务服务完成具体业务操作)

### 大型网站架构模式
---
1. 分层(横向切割:应用层,服务层,数据层)
2. 分割(垂直切割:购物,论坛,搜索,广告等,各自独立部署,由不同的团队负责)
3. 分布式(分布式应用和服务,分布式静态资源,分布式数据和存储,分布式计算)
4. 集群(利用负责均衡,提高系统的可用性)
5. 缓存(CDN,反向代理,本地缓存,分布式缓存)
6. 异步(生产者-消费者模式,消息队列解耦模块,提高系统可用性,加快网站响应速度,消除并发访问高峰)
7. 冗余(服务器预备,数据库备份)
8. 自动化(自动化发布,测试,部署,监控,失效转移,服务降级,资源分配)
9. 安全(验证码,XSS,SQL注入,编码转换)


### 大型网站核心架构要素
---

> 性能

#### 性能测试指标:

- 响应时间:发出请求到收到响应数据所需要的时间
- 并发数:系统同时处理请求的数量
- 吞吐量:单位时间内系统处理的请求数量,体现系统的整体处理能力(TPS每秒事务数,HPS每秒HTTP请求数,QPS每秒查询数) 
- 系能计数器:监控系统负载,对象与线程数,CPU使用,内存使用,磁盘与网络I/O等指标

#### 性能分析

检查各个环节的日志,分析哪个环节响应时间不合理,检查监控数据,分析影响性能的主要因素是内存、磁盘、网络还是CPU,是代码问题还是架构设计部合理,或者系统资源确实不足.

#### 优化一:WEB前端系能优化

- 减少HTTP请求数(合并CSS,JS,图片)
- 使用浏览器缓存(Cache-Control、Expires)
- 启用压缩(gzip压缩文本效率可达到80%以上)
- CSS放顶部,JS放尾部
- 减少COOKIE传输
- CDN加速
- 反向代理


#### 优化二:应用服务器性能优化

- 分布式缓存(一种以JBoss Cache为代表的同步更新的分布式缓存、另一种以Memcached为代表的互不通信的分布式缓存)
- 异步操作(任何可以晚点做的事情都应该晚点再做)
- 使用集群(使用负载均衡对付高并发的访问)
- 代码优化(多线程,资源复用、连接池、对象池、单例,数据结构,垃圾回收)


#### 优化三:存储性能优化

- 机械硬盘 vs. 固态硬盘
- B+树 vs. LSM树
- RAID vs. HDFS

> 可用性

网站可用性度量:99%,99.9%,99.99%

高可用的网站架构包括:应用层 + 服务层 + 数据层三个层次

#### 高可用的应用

应用层的无状态性,即不保存业务的上下午信息,每个服务实例之间完全对等,请求处理结果完全一样

通过负载均衡进行无状态服务的失效转移

应用服务器集群的Session管理:

- session复制,社和集群规模较小的应用
- session绑定,利用源地址Hash算法实现,请同一IP的请求分发到同一台服务器,一旦机器宕机,用户的业务请求就无法处理
- 利用cookie携带session信息,但cookie大小受限,而且cookie用户可以关闭cookie
- session服务器,将session存储到缓存或者数据中

#### 高可用的服务

可复用的服务模块为业务产品提供基础公共服务,大型网站中的这些服务通常都独立分布式部署,被具体远程服务调用

可复用的服务也是无状态的服务,具有类似负载均衡的失效转移策略实现高可用的服务,除此之外,还有以下策略:

- 分级管理,核心应用和服务优先使用更好的硬件,部署在不同地域的数据中心
- 超时设置,应用调用一旦超时,通信框架就抛出异常,应用根据服务调度策略,可选择继续重试或将请求转移到其它服务器
- 异步调用,应用对服务的调用通过异步消息队列方式完成,避免一个服务失败导致整个应用请求失败的情况
- 服务降级,拒绝部分请求或者低优先级服务以节约资源,关闭不重要的服务节约系统开销
- 幂等性设计,服务层必须保证服务重复调用和调用一次产生的结果相同

#### 高可用的数据

保证数据存储高可用的手段主要是数据备份和失效转移机制:

数据备份是保证数据有多个副本,任意副本的失效都不会导致数据的永久丢失,从而实现数据完全的持久化

失效转移机制则保证当一个副本不可访问时,可以快速切换访问数据的其它副本,保证系统可用

高可用的数据有三个层面的含义:

- 数据持久性
- 数据可访问性
- 数据一致性

##### CAP原理

一个提供数据服务的存储系统无法同时满足数据一致性(consistency),高可用性(availability),分区忍耐性(Partition Tolerance)这个三个条件

在大型网站应用中,数据规模总是快速扩张的,因此可伸缩性及分区忍耐性必不可少,规模变化以后,机器数量也会变得庞大,这是网络和服务器故障就会频繁出现,要想保证应用可用,就必须保证分布式处理系统的高可用性

所以在大型网站中,通常会选择强分布式存储系统的可用性(A)和伸缩性(P),而在某种程度上放弃一致性(C)

##### 数据备份

___冷备份___

方法:定期将数据复制到某种存储介质(磁盘,光盘)上并物理存档保管,如果系统损坏,那么久从冷备的存储设备中恢复数据

优点:简单低廉,成本和技术难度较低

缺点:不能保证数据最终一致

___热备份___

异步热备:多份数据的副本的写入异步完成,应用程序收到数据服务系统的写入操作时成功响应,只写成功了一份,存储系统将会异步写其它副本(这个过程可能会失败)

同步热备:多份数据副本的写入操作同步完成,即应用程序收到数据服务系统的写成功响应时,多份数据都已经写入成功,但是当应用程序收到数据写入失败的响应时,可能有部分副本或者全部副本都已经写入成功了(因为网络或者系统故障,无法返回操作成功的响应)

关系数据库的热备机制就是通常所说的Master-Slave同步机制,Master-Slave不但解决了数据备份问题,还改善了数据库系统的性能

##### 失效转移

若数据服务集群中任何一台服务器宕机,那么应用程序针对这台服务器的所有读写操作需要重新路由到其它服务器,保证数据访问不会失败,这个过程叫失效转移

失效转移操作由三部分组成:

- 失效确认:心跳检查和应用程序访问失败报告
- 访问转移:如果是完全对等的服务器,则可直接切换,如果是非对等,则需要重新计算路由,选择存储服务器
- 数据恢复

##### 高可用网站的软件质量保证

> 伸缩性




> 扩展性



> 安全性

